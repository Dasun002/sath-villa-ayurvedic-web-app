<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Success Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .success { color: #4CAF50; text-align: center; }
        .info { background: #e8f5e8; padding: 15px; border-radius: 5px; margin: 20px 0; }
        button { background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #45a049; }
        .error { color: #f44336; }
        .loading { color: #2196F3; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="success">üéâ Payment Successful!</h1>
        <p>Your payment has been processed successfully.</p>
        
        <div class="info">
            <h3>Payment Details:</h3>
            <p><strong>Session ID:</strong> <span id="sessionId"></span></p>
            <p><strong>Token:</strong> <span id="token"></span></p>
            <p><strong>Status:</strong> <span id="status">Checking...</span></p>
        </div>

        <div id="transactionDetails"></div>

        <button onclick="testPaymentConfirmation()">Test Payment Confirmation</button>
        <button onclick="generateTestReceipt()">Generate Test Receipt</button>
        
        <div id="result"></div>
    </div>

    <script>
        // Extract URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('session_id');
        const token = urlParams.get('t');

        document.getElementById('sessionId').textContent = sessionId || 'Not found';
        document.getElementById('token').textContent = token || 'Not found';

        // Test payment confirmation
        async function testPaymentConfirmation() {
            const resultDiv = document.getElementById('result');
            const statusSpan = document.getElementById('status');
            
            if (!sessionId && !token) {
                resultDiv.innerHTML = '<p class="error">Missing session_id or token in URL</p>';
                return;
            }

            try {
                statusSpan.textContent = 'Confirming payment...';
                statusSpan.className = 'loading';
                
                const params = new URLSearchParams();
                if (sessionId) params.append('session_id', sessionId);
                if (token) params.append('t', token);

                const response = await fetch(`http://localhost:5001/stripe/confirm?${params.toString()}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                statusSpan.textContent = data.status || 'Unknown';
                statusSpan.className = data.status === 'Paid' ? 'success' : 'error';
                
                document.getElementById('transactionDetails').innerHTML = `
                    <div class="info">
                        <h3>Transaction Details:</h3>
                        <p><strong>Name:</strong> ${data.name || 'N/A'}</p>
                        <p><strong>Email:</strong> ${data.email || 'N/A'}</p>
                        <p><strong>Amount:</strong> $${data.amount || 'N/A'}</p>
                        <p><strong>Package:</strong> ${data.packageType || 'N/A'}</p>
                        <p><strong>Transaction ID:</strong> ${data.transactionId || 'N/A'}</p>
                        ${data.booking ? `
                            <h4>Booking Details:</h4>
                            <p><strong>Guest:</strong> ${data.booking.b_name}</p>
                            <p><strong>Check-in:</strong> ${new Date(data.booking.b_checkInDate).toLocaleDateString()}</p>
                            <p><strong>Room:</strong> ${data.booking.b_roomNumber}</p>
                            <p><strong>Duration:</strong> ${data.booking.b_packageDuration} days</p>
                        ` : ''}
                    </div>
                `;
                
                resultDiv.innerHTML = '<p class="success">‚úÖ Payment confirmation successful!</p>';
                
            } catch (error) {
                console.error('Error:', error);
                statusSpan.textContent = 'Error';
                statusSpan.className = 'error';
                resultDiv.innerHTML = `<p class="error">‚ùå Error confirming payment: ${error.message}</p>`;
            }
        }

        // Generate test receipt
        function generateTestReceipt() {
            const receiptWindow = window.open('', '_blank', 'width=800,height=600');
            
            const receiptHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Sath Villa - Payment Receipt</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; color: #333; }
                        .header { text-align: center; border-bottom: 2px solid #4CAF50; padding-bottom: 20px; margin-bottom: 30px; }
                        .logo { font-size: 24px; font-weight: bold; color: #4CAF50; }
                        .info-row { display: flex; justify-content: space-between; margin: 8px 0; }
                        .label { font-weight: bold; }
                        @media print { body { margin: 0; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div class="logo">üåø Sath Villa Ayurvedic Wellness Resort</div>
                        <h2>Payment Receipt</h2>
                    </div>
                    
                    <div class="info-row">
                        <span class="label">Session ID:</span>
                        <span>${sessionId}</span>
                    </div>
                    <div class="info-row">
                        <span class="label">Token:</span>
                        <span>${token}</span>
                    </div>
                    <div class="info-row">
                        <span class="label">Date:</span>
                        <span>${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}</span>
                    </div>
                    
                    <p style="margin-top: 30px; text-align: center; color: #4CAF50;">
                        Thank you for choosing Sath Villa!
                    </p>
                    
                    <button onclick="window.print()" style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 10px; display: block; margin: 20px auto;">
                        Print Receipt
                    </button>
                </body>
                </html>
            `;

            receiptWindow.document.write(receiptHTML);
            receiptWindow.document.close();
        }

        // Auto-test when page loads
        setTimeout(() => {
            if (sessionId || token) {
                testPaymentConfirmation();
            }
        }, 1000);
    </script>
</body>
</html>